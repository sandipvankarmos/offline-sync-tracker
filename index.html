<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Task Tracker</title>
    <!-- Modern Styling and Icon Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase for Cloud Persistence -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 selection:bg-blue-100">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <nav class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-20">
            <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="bg-blue-600 p-1.5 rounded-lg text-white">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight">myWork<span class="text-blue-600">.AI</span></span>
                </div>
                <div id="sync-indicator" class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full text-[10px] font-bold text-slate-500 uppercase">
                    <i data-lucide="cloud" class="w-3 h-3 text-emerald-500"></i>
                    <span id="user-id-display">Connecting...</span>
                </div>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Analytics Sidebar -->
            <div class="lg:col-span-4 space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2 text-xs uppercase tracking-wider">
                        <i data-lucide="trending-up" class="w-4 h-4 text-blue-500"></i> Completion Rate
                    </h3>
                    <div class="relative flex justify-center items-center h-48">
                        <canvas id="statusChart"></canvas>
                        <div class="absolute flex flex-col items-center justify-center text-center">
                            <span id="percent-val" class="text-4xl font-black text-slate-800">0%</span>
                            <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Done</span>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900 text-white p-6 rounded-3xl shadow-xl">
                    <h3 class="font-bold mb-2 flex items-center gap-2 text-sm">
                        <i data-lucide="shield-check" class="text-blue-400 w-4 h-4"></i> Secure Cloud Sync
                    </h3>
                    <p class="text-slate-400 text-[11px] mb-4">Your tasks are synchronized in real-time to a secure database.</p>
                    <div class="p-3 bg-white/10 rounded-xl border border-white/10">
                        <p class="text-[9px] text-blue-300 font-bold uppercase mb-1">Status</p>
                        <p class="text-xs font-mono text-white opacity-80 truncate" id="env-status">Live Production</p>
                    </div>
                </div>
            </div>

            <!-- Task List Area -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                        <h2 class="font-bold text-lg flex items-center gap-2">
                            <i data-lucide="check-square" class="text-blue-600 w-5 h-5"></i> Project Roadmap
                        </h2>
                        <span id="task-counter" class="bg-blue-50 text-blue-600 text-[10px] px-2.5 py-1 rounded-lg font-bold">0 Tasks</span>
                    </div>
                    
                    <div id="task-container" class="divide-y divide-slate-50 max-h-[600px] overflow-y-auto custom-scroll">
                        <!-- Tasks will load here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Environment variables setup
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = window.__app_id || 'prod-app-' + Math.random().toString(36).substr(2, 9);
        
        // Firebase Initialization
        if (firebaseConfig.apiKey) {
            firebase.initializeApp(firebaseConfig);
        } else {
            console.warn("No Firebase config found. App running in local-only mode.");
        }

        const db = firebase.firestore();
        const auth = firebase.auth();

        let tasks = [];
        let chart = null;

        async function startApp() {
            // 1. Authenticate (required for Firestore)
            try {
                if (window.__initial_auth_token) {
                    await auth.signInWithCustomToken(window.__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (e) { console.error("Authentication failed", e); }

            // 2. Setup Listeners
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('user-id-display').innerText = "ID: " + user.uid.slice(0, 8);
                    subscribeToTasks();
                }
            });

            // 3. Initialize Visuals
            lucide.createIcons();
            initChart();
        }

        function subscribeToTasks() {
            const path = `artifacts/${appId}/public/data/tasks`;
            
            db.collection(path).onSnapshot(snapshot => {
                if (snapshot.empty) {
                    seedDefaultData(path);
                } else {
                    tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    tasks.sort((a,b) => a.phase - b.phase);
                    updateUI();
                }
            }, err => {
                console.error("Firestore error:", err);
                // Fallback for local testing if Firestore fails
                if(tasks.length === 0) seedDefaultData(null, true); 
            });
        }

        function seedDefaultData(path, localOnly = false) {
            const defaults = [
                { id: "1", phase: 1, text: "Configure Build Environment", file: "package.json", effort: 2, status: true },
                { id: "2", phase: 1, text: "Setup Tailwind Utility Classes", file: "tailwind.config.js", effort: 1, status: true },
                { id: "3", phase: 2, text: "Implement Real-time Sync", file: "sync.js", effort: 4, status: false }
            ];
            
            if (localOnly) {
                tasks = defaults;
                updateUI();
            } else {
                defaults.forEach(t => db.collection(path).doc(t.id).set(t));
            }
        }

        function initChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#2563eb', '#f1f5f9'],
                        borderWidth: 0,
                        borderRadius: 10
                    }]
                },
                options: { cutout: '85%', plugins: { legend: { display: false } } }
            });
        }

        function updateUI() {
            const container = document.getElementById('task-container');
            container.innerHTML = '';
            
            let doneEffort = 0;
            let totalEffort = 0;

            tasks.forEach(task => {
                totalEffort += task.effort;
                if(task.status) doneEffort += task.effort;

                const row = document.createElement('div');
                row.className = `p-5 flex items-center gap-4 transition-all ${task.status ? 'bg-slate-50/50 opacity-75' : 'hover:bg-slate-50'}`;
                row.innerHTML = `
                    <button onclick="toggleTask('${task.id}', ${task.status})" class="flex-shrink-0 ${task.status ? 'text-emerald-500' : 'text-slate-300'}">
                        <i data-lucide="${task.status ? 'check-circle' : 'circle'}" class="w-6 h-6"></i>
                    </button>
                    <div class="flex-1">
                        <div class="text-sm font-bold ${task.status ? 'line-through text-slate-400' : 'text-slate-800'}">${task.text}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[8px] bg-blue-100 px-1.5 py-0.5 rounded font-black text-blue-600 uppercase">Phase ${task.phase}</span>
                            <span class="text-[10px] text-slate-400 font-mono">${task.file}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-bold text-slate-700">${task.effort}h</span>
                    </div>
                `;
                container.appendChild(row);
            });

            // Update Analytics
            const percent = totalEffort > 0 ? Math.round((doneEffort / totalEffort) * 100) : 0;
            document.getElementById('percent-val').innerText = percent + '%';
            document.getElementById('task-counter').innerText = tasks.length + ' Tasks';
            
            chart.data.datasets[0].data = [doneEffort, totalEffort - doneEffort];
            chart.update();
            lucide.createIcons();
        }

        window.toggleTask = (id, currentStatus) => {
            const path = `artifacts/${appId}/public/data/tasks`;
            db.collection(path).doc(id).update({ status: !currentStatus });
        };

        // Start on load
        window.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>
